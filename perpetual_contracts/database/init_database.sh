#!/bin/bash
# ============================================================================
# 数据库初始化脚本
# ============================================================================
#
# 用途: 在全新数据库中创建所有表、视图和函数
#
# 使用方法:
#   ./init_database.sh
#
# ============================================================================

set -e  # 遇到错误立即退出

DB_NAME="perpetual_contracts_raw"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "=================================================="
echo "开始初始化数据库: $DB_NAME"
echo "=================================================="

# 检查数据库是否存在
if ! psql -lqt | cut -d \| -f 1 | grep -qw $DB_NAME; then
    echo "数据库 $DB_NAME 不存在，正在创建..."
    createdb $DB_NAME
    echo "✓ 数据库创建成功"
else
    echo "✓ 数据库已存在"
fi

# 1. 创建表
echo ""
echo "=================================================="
echo "步骤 1/4: 创建表结构"
echo "=================================================="
psql -d $DB_NAME -f "$SCRIPT_DIR/core/01_tables_schema.sql"
echo "✓ 表创建完成"

# 2. 创建统一交易信息视图
echo ""
echo "=================================================="
echo "步骤 2/4: 创建统一交易信息视图"
echo "=================================================="
psql -d $DB_NAME -f "$SCRIPT_DIR/core/02_unified_trading_info_view.sql"
echo "✓ 统一交易信息视图创建完成"

# 3. 创建原始数据视图
echo ""
echo "=================================================="
echo "步骤 3/4: 创建原始数据视图"
echo "=================================================="
psql -d $DB_NAME -f "$SCRIPT_DIR/core/03_raw_data_view.sql"
echo "✓ 原始数据视图创建完成"

# 4. 创建函数
echo ""
echo "=================================================="
echo "步骤 4/4: 创建函数"
echo "=================================================="
psql -d $DB_NAME -f "$SCRIPT_DIR/core/04_compare_params_function.sql"
echo "✓ 函数创建完成"

# 验证
echo ""
echo "=================================================="
echo "验证数据库对象"
echo "=================================================="
echo "表:"
psql -d $DB_NAME -c "\dt" -t | awk '{print "  - " $1}'
echo ""
echo "视图:"
psql -d $DB_NAME -c "\dv" -t | awk '{print "  - " $1}'
echo ""
echo "函数:"
psql -d $DB_NAME -c "\df" -t | awk '{print "  - " $1}'

echo ""
echo "=================================================="
echo "✅ 数据库初始化完成！"
echo "=================================================="
echo ""
echo "下一步:"
echo "  1. 运行数据采集脚本填充表数据"
echo "  2. 视图会自动基于表数据更新"
echo ""
