#!/bin/bash
# ============================================================================
# 视图更新脚本
# ============================================================================
#
# 用途: 重新创建所有视图（当视图定义有变化时使用）
#       注意：视图会自动基于表数据更新，通常不需要手动运行此脚本
#       只有在修改了视图的 SQL 定义文件后才需要运行
#
# 使用方法:
#   ./update_views.sh
#
# ============================================================================

set -e  # 遇到错误立即退出

DB_NAME="perpetual_contracts_raw"
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

echo "=================================================="
echo "开始更新视图: $DB_NAME"
echo "=================================================="

# 1. 更新统一交易信息视图
echo ""
echo "步骤 1/2: 更新统一交易信息视图"
psql -d $DB_NAME -f "$SCRIPT_DIR/core/02_unified_trading_info_view.sql"
echo "✓ 统一交易信息视图更新完成"

# 2. 更新原始数据视图
echo ""
echo "步骤 2/2: 更新原始数据视图"
psql -d $DB_NAME -f "$SCRIPT_DIR/core/03_raw_data_view.sql"
echo "✓ 原始数据视图更新完成"

# 验证
echo ""
echo "=================================================="
echo "当前视图列表:"
echo "=================================================="
psql -d $DB_NAME -c "\dv"

echo ""
echo "=================================================="
echo "✅ 视图更新完成！"
echo "=================================================="
echo ""
